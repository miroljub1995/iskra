using Iskra.StdWebGenerator.GeneratorContexts;
using Iskra.WebIDLGenerator.Extensions;
using Iskra.WebIDLGenerator.Models;
using Iskra.WebIDLGenerator.Utils;
using Microsoft.Extensions.DependencyInjection;

namespace Iskra.WebIDLGenerator.Generators;

public class GenericMarshallerGenerator(
    IServiceProvider provider,
    GenSettings genSettings,
    GeneratorContext generatorContext
)
{
    private readonly List<KeyValuePair<IDLTypeDescription, string>> _marshallers = [];

    public async Task GenerateAsync(CancellationToken cancellationToken = default)
    {
        var content = $$"""
                        // <auto-generated/>

                        namespace {{genSettings.Namespace}};

                        #nullable enable

                        public static partial class GenericMarshaller
                        {
                            [global::System.Runtime.InteropServices.JavaScript.JSImportAttribute("construct", "iskra")]
                            private static partial global::System.Runtime.InteropServices.JavaScript.JSObject ConstructObject(global::System.Runtime.InteropServices.JavaScript.JSObject obj, string constructorName);

                            [global::System.Runtime.InteropServices.JavaScript.JSImportAttribute("wrapPromiseValue", "iskra")]
                            private static partial global::System.Threading.Tasks.Task<global::System.Runtime.InteropServices.JavaScript.JSObject> WrapPromiseValue(global::System.Runtime.InteropServices.JavaScript.JSObject obj);

                            [global::System.Runtime.InteropServices.JavaScript.JSImportAttribute("unwrapPromiseValue", "iskra")]
                            private static partial global::System.Runtime.InteropServices.JavaScript.JSObject UnwrapPromiseValue(global::System.Threading.Tasks.Task<global::System.Runtime.InteropServices.JavaScript.JSObject> task);

                        {{GenerateArrayLikeElementClass().IndentLines(4)}}

                        {{GenerateUnionClass().IndentLines(4)}}

                        {{GenerateRecordClass().IndentLines(4)}}
                        }

                        #nullable disable
                        """;

        var outputFile = Path.GetFullPath(Path.Combine(genSettings.Output, "GenericMarshaller.cs"));
        if (File.Exists(outputFile))
        {
            throw new Exception($"Output file {outputFile} already exists.");
        }

        await File.WriteAllTextAsync(outputFile, content, cancellationToken);
    }

    public string GetOrCreateMarshaller(IDLTypeDescription input)
    {
        var found = TryFind(input);
        if (found is not null)
        {
            return found;
        }

        var name = input switch
        {
            FrozenArrayTypeDescription => $"global::{genSettings.Namespace}.GenericMarshaller.ArrayLikeElement",
            ObservableArrayTypeDescription => $"global::{genSettings.Namespace}.GenericMarshaller.ArrayLikeElement",
            SequenceTypeDescription => $"global::{genSettings.Namespace}.GenericMarshaller.ArrayLikeElement",
            PromiseTypeDescription => $"global::{genSettings.Namespace}.GenericMarshaller.Promise",
            UnionTypeDescription => $"global::{genSettings.Namespace}.GenericMarshaller.Union",
            RecordTypeDescription => $"global::{genSettings.Namespace}.GenericMarshaller.Record",
            _ => throw new NotSupportedException($"Type {input} is not supported.")
        };

        _marshallers.Add(new KeyValuePair<IDLTypeDescription, string>(input, name));

        return name;
    }

    private string? TryFind(IDLTypeDescription input)
    {
        foreach (var kvp in _marshallers)
        {
            if (IDLTypeDescriptionEqualityComparer.Instance.Equals(input, kvp.Key))
            {
                return kvp.Value;
            }
        }

        return null;
    }

    private string GenerateArrayLikeElementClass()
    {
        var toTypeDeclarationGenerator = provider.GetRequiredService<IDLTypeDescriptionToTypeDeclarationGenerator>();
        var getPropertyValueGenerator = provider.GetRequiredService<GetPropertyValueGenerator>();
        var setPropertyValueGenerator = provider.GetRequiredService<SetPropertyValueGenerator>();

        List<IDLTypeDescription> generatedElementTypes = [];

        List<string> interfaceParts = [];
        List<string> bodyParts = [];

        // Do not convert to foreach, new item could be added during iteration.
        for (var i = 0; i < _marshallers.Count; i++)
        {
            var marshaller = _marshallers[i];

            IDLTypeDescription elementType;
            if (marshaller.Key is FrozenArrayTypeDescription frozenArray)
            {
                elementType = frozenArray.IdlType.Single();
            }
            else if (marshaller.Key is ObservableArrayTypeDescription observableArray)
            {
                elementType = observableArray.IdlType.Single();
            }
            else if (marshaller.Key is SequenceTypeDescription sequence)
            {
                elementType = sequence.IdlType.Single();
            }
            else
            {
                continue;
            }

            if (generatedElementTypes.Any(x => IDLTypeDescriptionEqualityComparer.Instance.Equals(x, elementType)))
            {
                continue;
            }

            generatedElementTypes.Add(elementType);

            var elementVar = generatorContext.GetNextVariableName("element");

            var getElementContent = getPropertyValueGenerator.Generate(
                inputVar: "array",
                type: elementType,
                propertyNameVar: "index",
                outputVar: elementVar
            );

            var setElementContent = setPropertyValueGenerator.Generate(
                inputVar: "array",
                valueVar: "value",
                type: elementType,
                propertyNameVar: "index"
            );

            // var toManaged = GenerateToManaged(marshaller.Key);
            // var toJS = GenerateToJS(marshaller.Key);

            var elementTypeDesc = toTypeDeclarationGenerator.Generate(elementType);

            var interfacePart = $"global::Iskra.JSCore.Generics.IArrayLikeElementMarshaller<{elementTypeDesc}>";
            interfaceParts.Add(interfacePart);

            var bodyPart = $$"""
                             static {{elementTypeDesc}} {{interfacePart}}.Get(global::System.Runtime.InteropServices.JavaScript.JSObject array, int index)
                             {
                                 {{elementTypeDesc}} {{elementVar}};
                             {{getElementContent.IndentLines(4)}}
                                 return {{elementVar}};
                             }

                             static void {{interfacePart}}.Set(global::System.Runtime.InteropServices.JavaScript.JSObject array, int index, {{elementTypeDesc}} value)
                             {
                             {{setElementContent.IndentLines(4)}}
                             }
                             """;

            bodyParts.Add(bodyPart);
        }

        var interfaces = string.Join(",\n", interfaceParts);
        var body = string.Join("\n\n", bodyParts);

        var inheritance = interfaceParts.Count > 0
            ? $$"""
                :
                {{interfaces.IndentLines(4)}}
                """
            : string.Empty;

        var content = $$"""
                        public class ArrayLikeElement{{inheritance}}
                        {
                        {{body.IndentLines(4)}}
                        }
                        """;

        return content;
    }

    private string GenerateRecordClass()
    {
        var toTypeDeclarationGenerator = provider.GetRequiredService<IDLTypeDescriptionToTypeDeclarationGenerator>();

        List<IDLTypeDescription> generatedValueTypes = [];

        List<string> interfaceParts = [];
        List<string> bodyParts = [];

        // Do not convert to foreach, new item could be added during iteration.
        for (var i = 0; i < _marshallers.Count; i++)
        {
            var marshaller = _marshallers[i];

            if (marshaller.Key is not RecordTypeDescription recordTypeDescription)
            {
                continue;
            }

            var valueType = recordTypeDescription.IdlType.Skip(1).Single();

            if (generatedValueTypes.Any(x => IDLTypeDescriptionEqualityComparer.Instance.Equals(x, valueType)))
            {
                continue;
            }

            generatedValueTypes.Add(valueType);

            var valueTypeDecl = toTypeDeclarationGenerator.Generate(valueType);

            var interfacePart = $"global::Iskra.JSCore.Generics.IRecordValueMarshaller<{valueTypeDecl}>";
            interfaceParts.Add(interfacePart);

            var bodyPart = $$"""
                             static bool {{interfacePart}}.TryGetValue(
                                 global::System.Runtime.InteropServices.JavaScript.JSObject record,
                                 string key,
                                 [global::System.Diagnostics.CodeAnalysis.MaybeNullWhenAttribute(false)] out {{valueTypeDecl}} value
                             )
                             {
                                 throw new NotImplementedException();
                             }

                             static void {{interfacePart}}.Set(global::System.Runtime.InteropServices.JavaScript.JSObject record, string key, {{valueTypeDecl}} value)
                             {
                                 throw new NotImplementedException();
                             }
                             """;

            bodyParts.Add(bodyPart);
        }

        var interfaces = string.Join(",\n", interfaceParts);
        var body = string.Join("\n\n", bodyParts);

        var inheritance = interfaceParts.Count > 0
            ? $$"""
                :
                {{interfaces.IndentLines(4)}}
                """
            : string.Empty;

        var content = $$"""
                        public class Record{{inheritance}}
                        {
                        {{body.IndentLines(4)}}
                        }
                        """;

        return content;
    }

    private string GenerateUnionClass()
    {
        var toTypeDeclarationGenerator = provider.GetRequiredService<IDLTypeDescriptionToTypeDeclarationGenerator>();

        List<IDLTypeDescription> distinctItems = [];
        List<string> interfaceParts = [];
        List<string> bodyParts = [];
        foreach (var marshaller in _marshallers)
        {
            if (marshaller.Key is not UnionTypeDescription unionTypeDescription)
            {
                continue;
            }

            foreach (var itemType in unionTypeDescription.IdlType)
            {
                if (distinctItems.Any(x => IDLTypeDescriptionEqualityComparer.Instance.Equals(x, itemType)))
                {
                    continue;
                }

                distinctItems.Add(itemType);

                var toManaged = GenerateToManagedUnion(itemType);
                var toJS = GenerateToJSUnion(itemType);

                var marshalledType = toTypeDeclarationGenerator.Generate(itemType);

                var interfacePart = $"global::Iskra.JSCore.Generics.IUnionTypeMarshaller<{marshalledType}>";
                interfaceParts.Add(interfacePart);

                var bodyPart = $$"""
                                 static bool {{interfacePart}}.TryToManaged(global::System.Runtime.InteropServices.JavaScript.JSObject input, [global::System.Diagnostics.CodeAnalysis.MaybeNullWhenAttribute(false)] out {{marshalledType}} value)
                                 {
                                 {{toManaged.IndentLines(4)}}
                                 }

                                 static global::System.Runtime.InteropServices.JavaScript.JSObject {{interfacePart}}.ToJS({{marshalledType}} input)
                                 {
                                 {{toJS.IndentLines(4)}}
                                 }
                                 """;

                bodyParts.Add(bodyPart);
            }
        }

        var interfaces = string.Join(",\n", interfaceParts);
        var body = string.Join("\n\n", bodyParts);

        var inheritance = interfaceParts.Count > 0
            ? $$"""
                :
                {{interfaces.IndentLines(4)}}
                """
            : string.Empty;

        var content = $$"""
                        public class Union{{inheritance}}
                        {
                        {{body.IndentLines(4)}}
                        }
                        """;

        return content;
    }

    private string GenerateToManagedPromise(PromiseTypeDescription inpuit)
    {
        var toTypeDeclarationGenerator = provider.GetRequiredService<IDLTypeDescriptionToTypeDeclarationGenerator>();
        var getPropertyValueGenerator = provider.GetRequiredService<GetPropertyValueGenerator>();

        var elementType = inpuit.IdlType.Single();
        var returnTypeDeclaration = toTypeDeclarationGenerator.Generate(elementType, true);

        var taskVar = generatorContext.GetNextVariableName("task");
        var resVar = generatorContext.GetNextVariableName("res");

        var getValueContent = getPropertyValueGenerator.Generate(
            inputVar: taskVar,
            type: elementType,
            propertyNameVar: "\"value\"",
            outputVar: resVar
        );

        return $$"""
                 using global::System.Runtime.InteropServices.JavaScript.JSObject {{taskVar}} = await global::{{genSettings.Namespace}}.GenericMarshaller.WrapPromiseValue(input);
                 {{returnTypeDeclaration}} {{resVar}};
                 {{getValueContent}}
                 return {{resVar}};
                 """;
    }

    private string GenerateToJSPromise(PromiseTypeDescription input)
    {
        var setPropertyValueGenerator = provider.GetRequiredService<SetPropertyValueGenerator>();

        var toTypeDeclarationGenerator =
            provider.GetRequiredService<IDLTypeDescriptionToTypeDeclarationGenerator>();

        var elementType = input.IdlType.Single();
        var wrapperObjectVar = generatorContext.GetNextVariableName("wrapperObject");
        var resVar = generatorContext.GetNextVariableName("res");
        var taskVar = generatorContext.GetNextVariableName("task");
        var awaitedValueVar = generatorContext.GetNextVariableName("awaitedValue");
        var setValueFunctionName = generatorContext.GetNextVariableName("WrapTask");

        var elementTypeDeclaration = toTypeDeclarationGenerator.Generate(elementType, true);
        var taskTypeDeclaration = toTypeDeclarationGenerator.Generate(input, true);

        var setValueContent = setPropertyValueGenerator.Generate(
            inputVar: wrapperObjectVar,
            valueVar: awaitedValueVar,
            type: elementType,
            propertyNameVar: "\"value\""
        );

        return $$"""
                 static async global::System.Threading.Tasks.Task<global::System.Runtime.InteropServices.JavaScript.JSObject> {{setValueFunctionName}}({{taskTypeDeclaration}} {{taskVar}})
                 {
                     global::System.Runtime.InteropServices.JavaScript.JSObject {{wrapperObjectVar}} = global::{{genSettings.Namespace}}.GenericMarshaller.ConstructObject(global::System.Runtime.InteropServices.JavaScript.JSHost.GlobalThis, "Object");
                     {{elementTypeDeclaration}} {{awaitedValueVar}} = await {{taskVar}};
                     {{setValueContent.IndentLines(4)}}
                     return {{wrapperObjectVar}};
                 }

                 global::System.Runtime.InteropServices.JavaScript.JSObject {{resVar}} = global::{{genSettings.Namespace}}.GenericMarshaller.UnwrapPromiseValue({{setValueFunctionName}}(input));
                 return {{resVar}};
                 """;
    }


    private string GenerateToManagedUnion(IDLTypeDescription input)
    {
        var typeVar = generatorContext.GetNextVariableName("type");
        string typeCheckContent;
        if (input is SingleTypeDescription { IdlType: BuiltinTypes.Boolean })
        {
            typeCheckContent = $$"""
                                 if ({{typeVar}} != 1)
                                 {
                                     value = default;
                                     return false;
                                 }
                                 """;
        }
        else if (input is SingleTypeDescription
                 {
                     IdlType: BuiltinTypes.Byte or
                     BuiltinTypes.SignedByte or
                     BuiltinTypes.Short or
                     BuiltinTypes.UnsignedShort or
                     BuiltinTypes.Int32 or
                     BuiltinTypes.UnsignedInt32 or
                     BuiltinTypes.Int64 or
                     BuiltinTypes.UnsignedInt64 or
                     BuiltinTypes.Float or
                     BuiltinTypes.UnrestrictedFloat or
                     BuiltinTypes.Double or
                     BuiltinTypes.UnrestrictedDouble
                 })
        {
            typeCheckContent = $$"""
                                 if ({{typeVar}} != 2)
                                 {
                                     value = default;
                                     return false;
                                 }
                                 """;
        }
        else if (input is SingleTypeDescription { IdlType: BuiltinTypes.BigInt })
        {
            typeCheckContent = $$"""
                                 if ({{typeVar}} != 3)
                                 {
                                     value = default;
                                     return false;
                                 }
                                 """;
        }
        else if (input is SingleTypeDescription { IdlType: BuiltinTypes.String })
        {
            typeCheckContent = $$"""
                                 if ({{typeVar}} != 4)
                                 {
                                     value = default;
                                     return false;
                                 }
                                 """;
        }
        else if (input is SingleTypeDescription { IdlType: BuiltinTypes.ManagedObject })
        {
            typeCheckContent = $$"""
                                 if ({{typeVar}} != 8)
                                 {
                                     value = default;
                                     return false;
                                 }
                                 """;
        }
        else
        {
            typeCheckContent = $$"""
                                 if ({{typeVar}} != 7)
                                 {
                                     value = default;
                                     return false;
                                 }
                                 """;
        }

        var toTypeDeclarationGenerator = provider.GetRequiredService<IDLTypeDescriptionToTypeDeclarationGenerator>();
        var getPropertyValueGenerator = provider.GetRequiredService<GetPropertyValueGenerator>();

        var valueVar = generatorContext.GetNextVariableName("value");
        var getElementContent = getPropertyValueGenerator.Generate(
            inputVar: "input",
            type: input,
            propertyNameVar: "\"value\"",
            outputVar: valueVar
        );

        var typeDeclaration = toTypeDeclarationGenerator.Generate(input);

        return $$"""
                 double {{typeVar}} = global::Iskra.JSCore.Extensions.JSObjectPropertyExtensions.GetPropertyAsDoubleV2(input, "type");
                 {{typeCheckContent}}

                 try
                 {
                     {{typeDeclaration}} {{valueVar}};
                 {{getElementContent.IndentLines(4)}}

                     value = {{valueVar}};
                     return true;
                 }
                 catch
                 {
                     value = default;
                     return false;
                 }
                 """;
    }

    private string GenerateToJSUnion(IDLTypeDescription input)
    {
        var setPropertyValueGenerator = provider.GetRequiredService<SetPropertyValueGenerator>();
        var jsUnionVar = generatorContext.GetNextVariableName("jsUnion");

        var setValueContent = setPropertyValueGenerator.Generate(
            inputVar: jsUnionVar,
            valueVar: "input",
            type: input,
            propertyNameVar: "\"value\""
        );

        return $$"""
                 global::System.Runtime.InteropServices.JavaScript.JSObject {{jsUnionVar}} = ConstructObject(global::System.Runtime.InteropServices.JavaScript.JSHost.GlobalThis, "Object");
                 {{setValueContent}}
                 return {{jsUnionVar}};
                 """;
    }
}