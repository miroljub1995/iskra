using Iskra.StdWebGenerator.Extensions;

namespace Iskra.StdWebGenerator;

public class JSObjectCustomMethodsGenerator
{
    public static string Execute(GeneratorContext context)
    {
        var membersList = new List<string>();

        GenerateCustomMethodCalls(context, membersList);

        var members = string.Join("\n\n", membersList);

        return $$"""
                 // <auto-generated/>

                 using System.Runtime.InteropServices.JavaScript;

                 namespace Iskra.StdWeb;

                 #nullable enable

                 public static partial class JSObjectCustomMethodsExtensions
                 {
                 {{members.IndentLines(4)}}
                 }
                 """;
    }

    private static void GenerateCustomMethodCalls(GeneratorContext context, List<string> outputMembers)
    {
        outputMembers.AddRange(context.ObjectMethods.MethodCalls.Select(GenerateCustomMethodCall));
    }

    private static string GenerateCustomMethodCall(JSObjectMethodCallInfo method)
    {
        var returnTypeName = method.ReturnParam is null ? "void" : TypeNameGenerator.Execute(method.ReturnParam);

        var parameters = method.Parameters.Select((x, i) => $"{TypeNameGenerator.Execute(x)} arg{i}");
        var parametersForCall = method.Parameters.Select((x, i) => $"arg{i}");
        var parametersList = string.Join(", ", ["this JSObject obj", "string methodName", ..parameters]);

        var jsImportParameters = method.Parameters.Select((x, i) => $"{TypeNameGenerator.Execute(x)} arg{i}");
        var jsImportParametersList = string.Join(", ", ["JSObject func", "JSObject obj", ..jsImportParameters]);
        var jsImportCallParametersList = string.Join(", ", ["method", "obj", ..parametersForCall]);


        return
            $$"""
              [JSImport("globalThis.Function.prototype.call.call")]
              private static partial {{returnTypeName}} _{{method.Name}}({{jsImportParametersList}});

              public static {{returnTypeName}} {{method.Name}}({{parametersList}})
              {
                  var method = obj.GetPropertyAsJSObject(methodName)
                               ?? throw new Exception($"Method {methodName} not found.");
                               
                  {{(method.ReturnParam is null ? "" : "return ")}}_{{method.Name}}({{jsImportCallParametersList}});
              } 
              """;
    }
}