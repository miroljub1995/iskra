<html>
<head>
    <script type="module">
        import {dotnet} from "/_framework/dotnet.js";

        const run = async () => {
            let testInitModule = null;
            try {
                const r = await fetch("/test-extension-init.js");
                console.log(r.ok);
                testInitModule = await import("/test-extension-init.js");
            } catch (e) {
                // Ignore errors, it's optional
            }

            if (testInitModule) {
                await testInitModule.init();
            }

            const {runMain, getConfig, setModuleImports} = await dotnet.create();

            setModuleImports('iskra', {
                constructGlobalObject: (constructorName, ...args) => new globalThis[constructorName](...args),
                isGlobalConstructor: (constructorName, target) => globalThis[constructorName] === target.constructor,
                arrowFunctionProxy: (fun) => (...args) => fun(...args),
                ...(() => {
                    let nextId = 0;
                    const map = new Map();
                    return {
                        addConstructorFromProp: (obj, propName) => {
                            const id = nextId++;
                            map.set(obj[propName], id);
                            return id;
                        },
                        getConstructorId: (obj) => map.get(obj.constructor),
                    }
                })(),
            });

            const cfg = await getConfig();
            const res = await runMain(cfg.mainAssemblyName, []);

            return res;
        }

        globalThis.run = run;
    </script>
</head>
<body>
</body>
</html>